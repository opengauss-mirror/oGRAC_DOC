# oGRAC引擎多写技术特性概述

## 1. 多写能力概述

oGRAC引擎采用存算分离架构，通过分布式缓存、事务MVCC机制和多主集群高可用技术实现透明多读多写能力。分布式透明集群(DTC, Distributed Transparent Cluster)是支撑这一能力的核心架构，它由多个关键组件协同工作，确保多节点并发读写时的数据一致性和事务隔离性。

透明多写能力的主要特性包括：
- 全节点支持读写，无主从区分
- 跨节点事务一致性保证
- 分布式MVCC实现
- 全局SCN同步机制
- 分布式锁管理
- 高可用和故障自动恢复

oGRAC引擎通过分布式组件（DRC/DCS/DLS）实现集群化功能。

## 2. DMS各组件概述

分布式管理系统(DMS)是透明多写架构的核心，主要包含以下功能：

### 2.1 跨节点MVCC实现

MVCC (Multi-Version Concurrency Control) 机制在分布式环境下需要特殊处理，以确保跨节点的数据一致性。

**核心特性：**
- 支持跨实例CR页面构建
- 通过全局SCN机制确保版本一致性

**实现细节：**
- 每个事务拥有唯一的全局事务ID
- 数据修改生成新版本，并记录在undo日志中
- 跨节点查询时，通过CR页面构建可见数据视图

### 2.2 跨节点SCN推进

SCN (System Change Number) 是确保全局数据一致性的关键，跨节点SCN推进机制保证了集群内所有节点的SCN单调递增且最终一致。

**实现原理：**
- 通过广播机制实现节点SCN同步
- 采用自旋锁控制SCN更新的原子性
- 当本地SCN小于其他节点广播的SCN时，自动更新本地SCN
- 确保事务提交顺序的全局一致性

### 2.3 分布式锁

分布式锁服务(DLS, Distributed Lock Service)负责管理跨节点的锁资源，确保并发操作的数据一致性。

**实现机制：**
- 通过MES消息传递机制跨节点传递锁请求
- 支持自旋锁等锁操作原语
- 实现分布式锁等待和超时机制
- 提供锁降级和死锁检测能力

### 2.4 分布式缓存服务(DCS)

分布式缓存服务(DCS, Distributed Cache Service)是透明多写架构中负责管理跨节点页面缓存、页面所有权和CR页面构建的关键组件。

#### 2.4.1 DCS核心概念

**页面所有权：**
- 每个数据页面在任一时刻有且仅有一个拥有者(Owner)
- 拥有者节点对页面持有排他锁(EXCLUSIVE)，可以进行修改操作
- 其他节点可持有共享锁(SHARE)，只能进行读取操作

**EDP机制：**
- EDP(Earlier Dirty Page)表示节点上存在比当前页面版本更早的脏页
- 用于追踪和管理分布式环境下的页面版本依赖关系
- 确保页面刷新和检查点操作的正确性

**CR页面构建：**
- CR(Consistent Read)页面是为满足MVCC一致性读要求而构建的历史版本页面
- 支持堆表(HEAP)和索引(BTREE)的CR页面构建
- 通过分布式消息机制在节点间请求和传输CR页面

#### 2.4.2 DCS消息结构


#### 2.4.3 DCS核心功能

**1. 页面请求与所有权管理**

DCS实现了复杂的页面请求和所有权转让机制：

- **请求页面流程**：请求者发起页面请求，首先向主节点(Master)查询页面当前所有者，然后向所有者请求页面数据
- **所有权转让**：当页面所有者收到请求后，将页面数据传输给请求方，并更新锁状态
- **批量操作**：支持批量页面请求和所有权声明，提高系统吞吐量

**2. 脏页管理与EDP清理**

DCS提供了完善的脏页管理机制：

- **脏页追踪**：通过EDP位图跟踪节点上的脏页状态
- **脏页清理**：在CheckPoint期间清理全局脏页
- **主节点协调**：主节点负责协调跨节点的脏页清理工作

**3. CR页面构建与一致性读**

为支持分布式MVCC，DCS实现了跨节点的CR页面构建：

- **CR请求处理**：可处理不同类型的CR请求
- **主节点查询**：查询页面主节点，确定CR构建位置
- **CR页面构造**：在持有原始页面的节点上构造CR页面，并传输给请求节点

#### 2.4.4 DCS通信机制

DCS采用可靠的消息通信机制，确保节点间数据传输的正确性：

**消息重试机制：**
- 通过MES消息传递机制实现消息可靠发送
- 支持配置重试间隔和重试次数
- 检测目标节点状态，避免向不可用节点发送消息

**超时控制：**
- 设置消息等待超时，防止长时间阻塞
- 对CR请求设置单独的超时控制

**状态同步：**
- 节点状态变化时自动更新集群视图
- 通过心跳机制检测节点健康状态

#### 2.4.5 DCS性能优化

DCS实现了多种性能优化策略：

- **批量操作**：支持批量页面请求、批量所有权声明和批量释放操作
- **本地优先**：优先使用本地缓存，减少网络通信
- **并发处理**：支持多线程并发处理DCS消息
- **异步操作**：部分操作支持异步执行，提高响应速度

#### 2.4.6 DCS异常处理

DCS具备完善的异常处理机制：

- **资源清理**：节点故障时自动清理相关资源和锁
- **死锁检测**：提供分布式死锁检测和预防机制
- **日志记录**：详细记录异常情况，便于问题诊断

DCS作为透明多写架构的核心组件，通过复杂而精细的分布式缓存管理，确保了多节点环境下的数据一致性和高效访问，为oGRAC引擎的透明多读多写能力提供了坚实基础。

### 2.5 分布式资源目录(DRC)

分布式资源目录(DRC, Distributed Resource Catalog)是透明多写架构中负责管理集群范围内资源分配、资源所有权和资源迁移的核心组件。DRC确保了在多节点环境下资源的高效利用和一致性管理。

#### 2.5.1 DRC核心概念

- **资源分区管理**：DRC将系统资源划分为多个分区(part)，每个分区由特定节点管理，实现资源的分布式管理
- **资源所有权**：每个资源(如页面、锁)有明确的所有权标识，控制资源的访问权限
- **EDP机制**：(Earlier Dirty Page)，用于跟踪和管理脏页状态，确保数据一致性
- **资源迁移**：在集群Reform过程中，实现资源所有权的平滑迁移
- **资源回收**：自动回收失效或超时的资源，提高系统稳定性

#### 2.5.2 核心数据结构

#### 2.5.3 核心功能实现

1. **资源所有权管理**


2. **资源分区管理**

3. **DRC资源集中模式**

DRC支持资源集中模式(DRC_IN_REFORMER_MODE)，当所有业务只运行在reformer节点上时，可以通过开启此模式提升性能：

- 所有资源集中在reformer节点，减少跨节点资源请求
- 通过修改参数"DRC_IN_REFORMER_MODE"控制
- 适用于读写负载集中在特定节点的场景

#### 2.5.4 与Reform的协作

DRC与集群Reform机制紧密协作，在节点加入或离开集群时实现资源的平滑迁移：

### 2.6 集群Reform机制

集群Reform是透明多写架构中保证高可用性的关键机制，用于处理节点加入、离开、故障等场景，确保集群配置的一致性和服务的连续性。

#### 2.6.1 Reform核心概念

- **Reformer节点**：负责协调Reform过程的主节点，通常是当前集群的主节点
- **Reform角色**：节点在Reform过程中扮演的角色(STAY/LEAVE/JOIN/ABORT)
- **Reform模式**：Reform的触发方式(计划内/计划外)
- **资源重分配**：在Reform过程中重新分配系统资源所有权
- **部分恢复**：在节点加入或恢复时，只恢复必要的数据和状态
- **集群视图**：记录当前集群节点状态、版本和稳定性信息的数据结构

#### 2.6.2 Reform状态和流程

Reform的主要流程包括：
1. **准备阶段**：确定参与Reform的节点和各自角色
2. **构建通信通道**：确保节点间通信正常
3. **资源重分配(Remaster)**：重新分配资源所有权
4. **数据恢复**：确保所有节点数据一致性
5. **关闭临时通道**：清理Reform过程中的临时资源
6. **开放服务**：允许客户端连接和请求

#### 2.6.3 Reform过程详细实现

##### 2.6.3.1 Reform触发机制

Reform触发是通过专门的触发线程实现的，主要流程如下：

当检测到集群状态变化时，通过函数判断是否需要触发Reform：

##### 2.6.3.2 Reform状态机

Reform实现了复杂的状态机来管理Reform过程中的状态转换，状态机定义如下：

状态机基于四个维度的状态组合来确定下一步操作：
- 前CMS状态：节点在CMS中的之前的状态(ONLINE/OFFLINE)
- 后CMS状态：节点在CMS中的目标状态
- 前工作状态：节点的之前的工作状态(JOINING/JOINED/LEAVING/LEFT)
- 后工作状态：节点的目标工作状态

根据这些状态组合，状态机会决定：
- 需要执行的操作列表(REFORM_LIST_BEFORE/REFORM_LIST_AFTER/REFORM_LIST_JOIN/REFORM_LIST_LEAVE/REFORM_LIST_ABORT)
- 是否为成员变更操作
- 是否为不可能的状态转换(用于错误检测)

##### 2.6.3.3 主节点Reform流程
主节点的具体职责包括：
- 构建和维护Reform通信通道
- 协调资源重分配过程
- 收集和同步所有节点的状态
- 处理异常情况和错误恢复
- 通知所有节点Reform完成

##### 2.6.3.4 从节点Reform流程

从节点在Reform过程中的主要职责是响应主节点的指令并执行相应操作：

##### 2.6.3.5 集群视图管理

集群视图是Reform过程中的关键数据结构，用于跟踪集群状态：

集群视图的更新和同步由专门的函数处理：

##### 2.6.3.6 Reform完成检查

Reform完成后，需要进行一系列检查和状态更新：

#### 2.6.4 Reform模式和类型

Reform支持多种Reform模式和类型，以适应不同的场景：

1. **Reform模式**：
   - `REFORM_MODE_PLANED`：计划内Reform，如正常的节点添加或移除
   - `REFORM_MODE_OUT_OF_PLAN`：计划外Reform，如节点故障恢复
   - `REFORM_MODE_NONE`：无Reform状态

2. **节点角色**：
   - `REFORM_ROLE_STAY`：保持在集群中的节点
   - `REFORM_ROLE_JOIN`：新加入集群的节点
   - `REFORM_ROLE_LEAVE`：离开集群的节点
   - `REFORM_ROLE_ABORT`：异常终止的节点

3. **CMS状态**：
   - `RC_CMS_ONLINE`：节点在线
   - `RC_CMS_OFFLINE`：节点离线

4. **工作状态**：
   - `RC_JOINING`：节点正在加入集群
   - `RC_JOINED`：节点已加入集群
   - `RC_LEAVING`：节点正在离开集群
   - `RC_LEFT`：节点已离开集群

#### 2.6.5 异常处理和容错

Reform机制设计了完善的异常处理和容错机制：

1. **状态修复**：可修复可能的状态不一致问题

2. **超时处理**：可通过使用带超时的锁操作避免死锁

3. **失败重试**：关键操作通过宏实现自动重试

4. **位图同步**：可确保节点状态位图的一致性

5. **错误检测和恢复**：通过错误码和状态检查进行异常处理

#### 2.6.6 与DRC的协作

Reform与DRC紧密协作，实现资源的平滑迁移和重分配：

在Reform过程中，Reform和DRC的协作流程如下：

1. Reform触发资源重分配(Remaster)过程
2. DRC协调各节点准备重分配
3. 主节点计算新的资源分配方案
4. 各节点执行资源迁移
5. 迁移完成后确认并通知Reform
6. Reform继续后续的Reform步骤

#### 2.6.7 Remaster过程详细实现

Remaster过程是Reform机制中的核心环节，负责在节点角色或集群拓扑变化时重新分配和迁移资源。下面详细介绍Remaster的实现机制：

##### 2.6.7.1 Remaster核心管理结构

##### 2.6.7.2 Remaster过程的四个阶段

1. **准备阶段(REMASTER_PREPARE)**
   - 初始化Remaster管理器
   - 清理离开节点的资源
   - 等待所有节点准备就绪

2. **任务分配阶段(REMASTER_ASSIGN_TASK)**
   - Master节点根据新的集群拓扑分配分区任务
   - 确定每个分区的导出节点和导入节点

3. **资源迁移阶段(REMASTER_MIGRATE)**
   - 执行缓冲区资源迁移
   - 执行锁资源迁移
   - 等待迁移完成

4. **清理和完成阶段**
   - 释放迁移后的资源
   - 确认所有任务完成
   - 更新集群状态

##### 2.6.7.3 核心实现函数

#### 2.6.8 日志回放流程详细实现

日志回放流程负责在Reform过程中恢复数据一致性，特别是在节点故障或拓扑变化时。下面详细介绍日志回放的实现机制：

##### 2.6.8.1 日志回放核心流程

1. **日志读取阶段**
   - 并行读取多个节点的redo日志
   - 加载日志批次到内存缓冲区

2. **日志分析阶段(ANALYSIS)**
   - 分析日志批次，确定需要恢复的页面
   - 构建恢复数据集

3. **日志回放阶段(RECOVERY)**
   - 并行回放日志组
   - 应用变更到数据页面

4. **一致性验证阶段**
   - 验证数据一致性
   - 更新SCN和恢复点

#### 2.6.9 Reform性能监控

oGRAC提供了丰富的Reform性能监控指标，便于跟踪和分析Reform过程：

- 准备阶段耗时
- 恢复阶段耗时
- 资源迁移耗时

## 3. DSS介绍

### 3.1 DSS核心功能

分布式存储系统(DSS, Distributed Storage System)提供底层的存储管理能力，为透明多写架构提供稳定的数据存储基础。

**核心功能：**
- 统一的文件操作API抽象
- 分布式存储访问能力
- 多节点数据共享

**实现细节：**
- 通过动态库`libdssapi.so`提供存储访问能力
- 支持完整的文件操作：创建、读写、删除、重命名等
- 实现AIO异步IO操作，提升性能
- 提供日志回调和连接管理机制

**主要API：**
```c
// 核心文件操作API
dss_fcreate - 创建文件
dss_fopen - 打开文件
dss_fread - 读取文件
dss_fwrite - 写入文件
dss_fclose - 关闭文件
dss_fremove - 删除文件
dss_frename - 重命名文件

// 异步IO相关API
dss_aio_prep_pread - 准备异步预读
dss_aio_prep_pwrite - 准备异步预写
dss_aio_post_pwrite - 提交异步写
```

**日志级别定义：**
- DSS_LOG_LEVEL_ERROR: 错误级别
- DSS_LOG_LEVEL_WARN: 警告级别
- DSS_LOG_LEVEL_INFO: 信息级别

## 4. DBStor介绍

DBStor是oGRAC引擎的数据库存储管理组件，提供命名空间管理、页面池、日志管理等核心功能。

### 4.1 核心概念

**命名空间：**
- 逻辑隔离的数据管理单元
- 支持多节点并发访问
- 通过命名空间ID唯一标识

**页面池：**
- 内存与存储之间的缓冲层
- 支持页面读写、异步写入、同步等操作
- 提供页面大小配置和分区管理

**Ulog (Undo Log)：**
- 事务日志管理组件
- 支持多种操作模式：追加模式、带LSN模式等
- 提供日志读取、截断、归档等功能

### 4.2 主要功能模块

**命名空间管理：**
```c
// 命名空间相关API
create_namespace_t - 创建命名空间
open_namespace_t - 打开命名空间
set_term_access_mode_for_ns_t - 设置终端访问模式
```

**文件系统操作：**
- 文件创建、打开、读写、删除
- 目录管理
- 文件元数据查询

**锁管理：**
- 实例锁操作
- 心跳检测
- 故障检测和恢复

**快照管理：**
```c
// 快照相关功能
create_fs_snap - 创建文件系统快照
delete_fs_snap - 删除文件系统快照
```

### 4.3 部署模式

DBStor支持两种主要部署模式：
NAS模式
非NAS模式

**配置参数：**
- 命名空间名称
- 本地/远程IP配置
- 集群ID
- 用户名密码等认证信息